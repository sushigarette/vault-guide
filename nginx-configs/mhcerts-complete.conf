# Configuration Nginx complète pour mhcerts.infra.mhcomm.fr
# Ce fichier contient toutes les configurations pour tous les projets
# À placer dans /etc/nginx/sites-available/mhcerts

server {
    listen 80;
    listen [::]:80;
    server_name mhcerts.infra.mhcomm.fr _;

    # Headers CORS globaux (si nécessaire)
    add_header 'Access-Control-Allow-Origin' '*' always;
    add_header 'Access-Control-Allow-Methods' 'GET, POST, PUT, PATCH, DELETE, OPTIONS' always;
    add_header 'Access-Control-Allow-Headers' 'Authorization,Content-Type,Accept,Origin,User-Agent,DNT,Cache-Control,X-Mx-ReqToken,Keep-Alive,X-Requested-With,If-Modified-Since' always;
    add_header 'Access-Control-Allow-Credentials' 'true' always;

    # ============================================
    # FICHIERS STATIQUES MHSTOCK (à la racine)
    # Ces fichiers sont référencés avec des chemins absolus
    # On les intercepte AVANT la location / pour mhcerts
    # IMPORTANT: Ces locations doivent être AVANT location /
    # ============================================
    
    # Assets de mhstock à la racine (si référencés avec /assets/...)
    # On vérifie d'abord si le fichier existe dans mhstock, sinon on laisse passer
    location /assets/ {
        # Essayer d'abord dans mhstock
        try_files $uri @mhcerts_assets;
        root /var/www/mhstock/dist;
        expires 1y;
        add_header Cache-Control "public, immutable";
    }
    
    location @mhcerts_assets {
        # Si pas trouvé dans mhstock, chercher dans mhcerts
        root /var/www/mhcerts;
        expires 1y;
        add_header Cache-Control "public, immutable";
    }
    
    location = /sw.js {
        alias /var/www/mhstock/dist/sw.js;
        add_header Cache-Control "public, max-age=3600";
    }
    
    location = /manifest.json {
        alias /var/www/mhstock/dist/manifest.json;
        add_header Cache-Control "public, max-age=3600";
    }
    
    location = /favicon.svg {
        alias /var/www/mhstock/dist/favicon.svg;
        add_header Cache-Control "public, max-age=3600";
    }
    
    location = /favicon.ico {
        alias /var/www/mhstock/dist/favicon.ico;
        add_header Cache-Control "public, max-age=3600";
    }
    
    location = /apple-touch-icon.png {
        alias /var/www/mhstock/dist/apple-touch-icon.png;
        add_header Cache-Control "public, max-age=3600";
    }

    # ============================================
    # MHCRTS - Projet principal (racine)
    # ============================================
    
    # Note: Les assets de mhcerts sont gérés par la location /assets/ ci-dessus
    # qui vérifie d'abord mhstock puis mhcerts

    # Configuration principale pour mhcerts
    location / {
        root /var/www/mhcerts;
        try_files $uri $uri/ /index.html;
        
        # Headers de sécurité
        add_header X-Frame-Options "SAMEORIGIN" always;
        add_header X-Content-Type-Options "nosniff" always;
        add_header X-XSS-Protection "1; mode=block" always;
    }

    # API pour mhcerts
    location /api/ {
        proxy_pass http://localhost:3001;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # ============================================
    # MHSTOCK - Gestion de stock
    # ============================================
    
    # Assets statiques pour mhstock (AVANT location /mhstock/)
    location /mhstock/assets/ {
        alias /var/www/mhstock/dist/assets/;
        expires 1y;
        add_header Cache-Control "public, immutable";
        
        # Types MIME corrects
        location ~* \.js$ {
            add_header Content-Type "application/javascript; charset=utf-8";
        }
        
        location ~* \.css$ {
            add_header Content-Type "text/css; charset=utf-8";
        }
    }

    # Service Worker et fichiers statiques pour mhstock (depuis /mhstock/)
    location ~* ^/mhstock/(sw\.js|manifest\.json|favicon\.(ico|svg)|apple-touch-icon\.png|icon-.*\.png|robots\.txt|placeholder\.svg)$ {
        alias /var/www/mhstock/dist/;
        rewrite ^/mhstock/(.*)$ /$1 break;
        add_header Cache-Control "public, max-age=3600";
    }

    # Configuration principale pour mhstock
    location /mhstock/ {
        alias /var/www/mhstock/dist/;
        index index.html;
        try_files $uri $uri/ @mhstock_fallback;

        # Headers de sécurité
        add_header X-Frame-Options "SAMEORIGIN" always;
        add_header X-Content-Type-Options "nosniff" always;
        add_header X-XSS-Protection "1; mode=block" always;
    }

    # Fallback pour mhstock (routing React - SPA)
    location @mhstock_fallback {
        rewrite ^/mhstock/(.*)$ /mhstock/index.html last;
    }

    # API pour mhstock (si nécessaire)
    location /mhstock-api/ {
        proxy_pass http://localhost:3002;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # ============================================
    # MHCSE - CSE Bonnes Affaires
    # ============================================
    
    # Assets statiques pour mhcse (AVANT location /mhcse/)
    location /mhcse/assets/ {
        alias /var/www/mhcse/dist/assets/;
        expires 1y;
        add_header Cache-Control "public, immutable";
        
        # Types MIME corrects
        location ~* \.js$ {
            add_header Content-Type "application/javascript; charset=utf-8";
        }
        
        location ~* \.css$ {
            add_header Content-Type "text/css; charset=utf-8";
        }
    }

    # Configuration principale pour mhcse
    location /mhcse/ {
        alias /var/www/mhcse/dist/;
        index index.html;
        try_files $uri $uri/ @mhcse_fallback;

        # Headers de sécurité
        add_header X-Frame-Options "SAMEORIGIN" always;
        add_header X-Content-Type-Options "nosniff" always;
        add_header X-XSS-Protection "1; mode=block" always;
    }

    # Fallback pour mhcse (routing React - SPA)
    location @mhcse_fallback {
        rewrite ^/mhcse/(.*)$ /mhcse/index.html last;
    }

    # API pour mhcse
    location /mhcse-api/ {
        proxy_pass http://localhost:3003;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}

